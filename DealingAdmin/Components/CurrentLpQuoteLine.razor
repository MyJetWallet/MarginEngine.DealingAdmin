@using DealingAdmin.Abstractions
@using DealingAdmin.Abstractions.Models
@using DealingAdmin.Services
@using DealingAdmin.Shared.Services
@using SimpleTrading.Abstraction.BidAsk

@inject IBidAskCache bidAskCache
@inject IPriceRetriever priceRetriever

<div class="grid-container-lp-quote-line">    
    <div>
        @if (bidAsk == null)
        {
            <span class="material-icons color-red md-18 vertical-baseline">warning_amber</span>
        }
    </div>
    <div><span class="text-bold">Current</span></div>
    <div>@bidAsk?.Bid.ToString($"F{digits}")</div>
    <div><span class="text-bold">Current</span></div>
    <div>@bidAsk?.Ask.ToString($"F{digits}")</div>
    <div><span class="text-bold">Current</span></div>
    <div>@spread</div>
    <div><span class="text-bold">Current</span></div>
    <div><span>@bidAsk?.Date</span>
        @if (bidAsk != null && bidAsk.TimeWarning)
        {
            <span class="material-icons color-orange md-18 vertical-baseline">warning_amber</span>
        }
    </div>
</div>

@code {
    [Parameter]
    public InstrumentQuoteModel Instrument { get; set; }

    private BidAskModel bidAsk { get; set; }
    private bool isUpdating = false;
    private int digits = 2;
    private int spread;

    protected override async Task OnInitializedAsync()
    {
        digits = Instrument.Digits;
        var nowBidAsk = bidAskCache.Get(Instrument.Id);

        if (nowBidAsk != null)
        {
            bidAsk = nowBidAsk.ToBidAskModel();
            spread = FxUtils.CalcSpread(bidAsk, digits);
        }
        else
        {
            bidAsk = null;
        }

        AppJobService.QuotesUpdateEvent += async () => await InvokeAsync(() => UpdateBidAsk());
    } 

    private void UpdateBidAsk()
    {
        if (isUpdating)
        {
            return;
        }

        isUpdating = true;

        var currentBidAsk = priceRetriever.GetBidAsk(Instrument.Id);

        if (currentBidAsk != null)
        {
            SetBidAsk(currentBidAsk);
        }

        isUpdating = false;      
    }

    public void SetBidAsk(BidAskModel bidAskNow)
    {
        bidAsk = bidAskNow;
        spread = FxUtils.CalcSpread(bidAsk, digits);
        this.StateHasChanged();
    }
}
