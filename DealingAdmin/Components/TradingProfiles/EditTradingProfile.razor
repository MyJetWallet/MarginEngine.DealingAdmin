@using DealingAdmin.Abstractions
@using DealingAdmin.Abstractions.Models
@using DealingAdmin.Shared.Services
@using Serilog.Core
@using SimpleTrading.Abstraction.Trading.Instruments

@inject StateManager AppState
@inject LiveDemoServiceMapper liveDemoServices
@inject ITradingInstrumentsRepository instrumentsRepository
@inject ITradingProfileNewInstrumentsValidator profileNewInstrumentsValidator
@inject ISnackbar snackbar
@inject Logger logger
@inject NavigationManager navManager

<PageHeader Class="m-0 p-0" Title="@pageTitle"/>
<AntDesign.Row>
    <Col Flex=@("320px") Class="px-2">
        Profile Id:
        <Input @bind-Value="@TradingProfile.Id"
                Placeholder="Profile Id"
                Style="width:240px"
                Disabled="@(!isNewProfile)"
                Rules=@RequiredRule/>
    </Col>
    <Col Flex=@("160px") Class="px-2">
        Margin Call %
        <Input @bind-Value="@TradingProfile.MarginCallPercent"
                Placeholder="Margin Call %"
                Disabled="@(!isNewProfile)"
                Rules=@RequiredRule/>
    </Col>
    <Col Flex=@("160px") Class="px-2">
        Stop Out %
        <Input @bind-Value="@TradingProfile.StopOutPercent"
                Placeholder="Stop Out %"
                Disabled="@(!isNewProfile)"
                Rules=@RequiredRule/>
    </Col>
    <Col Flex=@("160px") Class="px-2">
        Stop Out %
        <Input @bind-Value="@TradingProfile.StopOutPercent"
                Placeholder="Stop Out %"
                Disabled="@(!isNewProfile)"
                Rules=@RequiredRule/>
    </Col>
    <Col Flex=@("160px") Class="px-2">
        Topping Up %
        <Input @bind-Value="@TradingProfile.PositionToppingUpPercent"
                Placeholder="Topping Up %"
                Disabled="@(!isNewProfile)"
                Rules=@RequiredRule/>
    </Col>
    <Col Flex=@("auto")>
    </Col>
    <Col Flex=@("160px")>
        <AntDesign.Button Icon="check"
            Class="btn-text bg-color-aquamarine"
            OnClick="SaveTradingProfile"
            Disabled="@(String.IsNullOrEmpty(TradingProfile.Id))">Save</AntDesign.Button>
    </Col>
    <Col Flex=@("160px")>
        <AntDesign.Button Icon="arrow-left"
            Class="btn-text bg-color-yellow"
            OnClick="GoBack">Back</AntDesign.Button>
    </Col>
</AntDesign.Row>

<Table DataSource="@TradingProfile.Instruments"
       TItem="TradingProfileInstrumentModel"
       Bordered="@true"
       Total="0"
       HidePagination="@true"
       ScrollY="calc(100vh - 200px)"
       PageSize="999">
    <TitleTemplate>
        <PageHeader Title="Profile Instruments" Class="m-0 p-0">
            <PageHeaderExtra>
                 <AntDesign.Button 
                    OnClick="ShowNewInstrumentDialog" 
                    Type="@AntDesign.ButtonType.Primary"
                    Class="btn-text">Add Instrument</AntDesign.Button>
            </PageHeaderExtra>
        </PageHeader>
    </TitleTemplate>
    <RowTemplate>           
        <AntDesign.Column Title="Instrument Id"
                TData="string"
                DataIndex="Id"
                Sortable/>
        <AntDesign.Column Title="Operation Volume" TData="string">
            <div>Max: @context.MaxOperationVolume</div>
            <div>Min: @context.MinOperationVolume</div>
        </AntDesign.Column>
        <AntDesign.Column Title="Max Position Volume"
                TData="double"
                DataIndex="MaxPositionVolume"
                Sortable/>
        <AntDesign.Column Title="Open Position Delay" TData="string">
            <div>Max: <Tag PresetColor="@PresetColor.Red">@context.OpenPositionMaxDelayMs</Tag> ms</div>
            <div>Min: <Tag PresetColor="@PresetColor.Green">@context.OpenPositionMinDelayMs</Tag> ms</div>
        </AntDesign.Column>
        <AntDesign.Column Title="Slippage" TData="string">
            <div><Checkbox Checked="@context.TpSlippage">Take Profit</Checkbox></div>
            <div><Checkbox Checked="@context.SlSlippage" Disabled="@true"></Checkbox>Stop Loss</div>
            <div><Checkbox Checked="@context.OpenPositionSlippage" Class="no-click">Open Position</Checkbox></div>
        </AntDesign.Column>
        <AntDesign.Column Title="Leverages" TData="string">
            <span>@(String.Join(" ", context.Leverages))</span>
        </AntDesign.Column>
        <AntDesign.Column Title="Stop Out %"
                TData="double?"
                DataIndex="StopOutPercent"
                Sortable/>
        <ActionColumn Title="Actions">
            <Tooltip Title="@("Edit")">
                <a><i @onclick="()=>ShowEditInstrumentDialog(context)"
                    class="material-icons color-primary">edit</i></a>
            </Tooltip>
            <Tooltip Title="@("Clone")">
                <a><i @onclick="()=>CloneInstrument(context)"
                    class="material-icons color-green">content_copy</i></a>
            </Tooltip>
            <Tooltip Title="@("Delete")">
                <Popconfirm Title="Are you sure?" OkText="Confirm" CancelText="Cancel">
                    <a><i @onclick="()=>DeleteInstrument(context)"
                        class="material-icons color-crimson">delete_outline</i></a>
                </Popconfirm>
            </Tooltip>
        </ActionColumn>
    </RowTemplate>
</Table>

@code {
    [Parameter]
    public TradingProfileModel TradingProfile { get; set; }

    [Parameter]
    public EventCallback OnGoBack { get; set; }

    TradingProfileInstrumentModel selectedInstrument;
    TradingProfileInstrumentModel editedInstrument = new TradingProfileInstrumentModel();
    List<string> instrumentIds;
    List<string> availableInstruments;

    private FormValidationRule[] RequiredRule = { new FormValidationRule { Required = true } };
    private FormValidationRule[] RequiredIntRule = { new FormValidationRule { Required = true, Type = FormFieldType.Integer } };

    private string profileId { get; set; }

    private bool isNewProfile = true;

    private string pageTitle = "Add New Trading Profile";
    private string instrumentEditFormTitle = "";
    private string profileEditFormTitle;
    private bool isEditInstrumentDialogVisible;

    protected override async Task OnInitializedAsync()
    {
        if (!String.IsNullOrEmpty(TradingProfile.Id))
        {
            profileId = TradingProfile.Id;
            pageTitle = $"Edit '{profileId}' Trading Profile";
            isNewProfile = false;
        }

        instrumentIds = (await instrumentsRepository.GetAllAsync()).Select(x => x.Id).ToList();
        availableInstruments = GetAvailableInstrumentsList();

        AppState.LiveDemoModeChanged += async () => await InvokeAsync(() => GoBack());
    }

    private List<string> GetAvailableInstrumentsList()
    {
        var resultSet = new List<string>();

        if (selectedInstrument != null)
        {
            resultSet.Add(selectedInstrument.Id);
        }
        else if (TradingProfile.Instruments.Any()) 
        {
            foreach(var instId in instrumentIds)
            {
                if (!TradingProfile.Instruments.Where(x => x.Id == instId).Any())
                {
                    resultSet.Add(instId);
                }
            }
        }
        else
        {
            resultSet.AddRange(instrumentIds);
        }

        return resultSet;
    }

    private void ShowNewInstrumentDialog()
    {
        selectedInstrument = null;
        availableInstruments = GetAvailableInstrumentsList();

        editedInstrument = new TradingProfileInstrumentModel 
        {
            Id = availableInstruments.FirstOrDefault()
        };

        instrumentEditFormTitle = $"Add New Instrument for Trading Profile {profileId}";
        isEditInstrumentDialogVisible = true;
    }

    private void ShowEditInstrumentDialog(TradingProfileInstrumentModel profileItem)
    {
        selectedInstrument = profileItem;
        editedInstrument = TradingProfileInstrumentModel.Create(profileItem);
        availableInstruments = GetAvailableInstrumentsList();
        instrumentEditFormTitle = $"Edit '{profileItem.Id}' Instrument for Trading Profile {profileId}";
        isEditInstrumentDialogVisible = true;
    }

    private void CloneInstrument(TradingProfileInstrumentModel profileItem)
    {
        selectedInstrument = null;
        editedInstrument = TradingProfileInstrumentModel.Create(profileItem);
        availableInstruments = GetAvailableInstrumentsList();
        instrumentEditFormTitle = $"Add New Instrument for Trading Profile {profileId}";
        isEditInstrumentDialogVisible = true;
    }

    private void DeleteInstrument(TradingProfileInstrumentModel profileItem)
    {
        TradingProfile.Instruments.Remove(profileItem);
    }

    private void SaveInstrument()
    {
        if (selectedInstrument != null)
        {
            selectedInstrument = TradingProfileInstrumentModel.Create(editedInstrument);
        }
        else
        {
            TradingProfile.Instruments.Add(editedInstrument);
        }

        isEditInstrumentDialogVisible = false;
    }

    protected async Task SaveTradingProfile()
    {
        var profileNewInstrumentsValidatorErrorMessage =
            await profileNewInstrumentsValidator.ValidateTradingProfileNewInstruments(TradingProfile, AppState.IsLive);

        if (!String.IsNullOrEmpty(profileNewInstrumentsValidatorErrorMessage))
        {
            snackbar.Add(profileNewInstrumentsValidatorErrorMessage, Severity.Error);
        }

        await liveDemoServices.GetContext(AppState.IsLive).TradingProfileRepository.UpdateAsync(TradingProfile);
        snackbar.Add($"Trading Profile '{TradingProfile.Id}' saved", Severity.Success);
    }

    private async void GoBack()
    {
        await OnGoBack.InvokeAsync();
    }

    private void RemainBoolValue(bool newValue)
    {
        
    }
}
